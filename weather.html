<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å¤©æ°£æŸ¥è©¢</title>
</head>
<body>
  <h1>å°ç£å„ç¸£å¸‚å¤©æ°£æŸ¥è©¢</h1>

  <label for="city">è«‹é¸æ“‡åŸå¸‚ï¼š</label>
<select id="city">
  <option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
  <option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
  <option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option>
  <option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
  <option value="è‹—æ —ç¸£" selected>è‹—æ —ç¸£</option>
  <option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
  <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option>
  <option value="é›²æ—ç¸£">é›²æ—ç¸£</option>
  <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option>
  <option value="å±æ±ç¸£">å±æ±ç¸£</option>
  <option value="è‡ºæ±ç¸£">è‡ºæ±ç¸£</option>
  <option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
  <option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option>
  <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option>
  <option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option>
  <option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
  <option value="è‡ºåŒ—å¸‚">è‡ºåŒ—å¸‚</option>
  <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
  <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
  <option value="è‡ºä¸­å¸‚">è‡ºä¸­å¸‚</option>
  <option value="è‡ºå—å¸‚">è‡ºå—å¸‚</option>
  <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
</select>


  <div id="weather" style="margin-top: 1em;">è¼‰å…¥ä¸­...</div>

  <script>
    const clientId = "B11023039-f4f6e326-1e83-4290";
    const clientSecret = "66fff3c0-c85d-49b0-ab53-df5fa3d40ee8";

    async function getToken() {
      const res = await fetch("https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({
          grant_type: "client_credentials",
          client_id: clientId,
          client_secret: clientSecret
        })
      });

      const data = await res.json();
      return data.access_token;
    }

    async function fetchWeather(city) {
      document.getElementById("weather").innerText = "è¼‰å…¥ä¸­...";

      const token = await getToken();
      const graphqlEndpoint = "https://tdx.transportdata.tw/api/cwa/graphql?Authorization=TDX-2A1E325A-C117-4EDB-B4B6-822AACF5088E";

      const query = `
        query forecast {
          forecast(LocationName: "${city}") {
            Locations {
              LocationName
              Temperature {
                Time {
                  StartTime
                  Temperature
                }
              }
              Weather {
                Time {
                  StartTime
                  Weather
                }
              }
            }
          }
        }
      `;

      const response = await fetch(graphqlEndpoint, {
        method: "POST",
        headers: {
          Authorization: "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ query })
      });

      const result = await response.json();
      const location = result?.data?.forecast?.Locations?.[0];
      if (!location) {
        document.getElementById("weather").innerText = "æ‰¾ä¸åˆ°å¤©æ°£è³‡æ–™ã€‚";
        return;
      }

      const tempData = location?.Temperature?.Time ?? [];
      const weatherData = location?.Weather?.Time ?? [];

      // ç”¨ Map å„²å­˜æ¯å¤©çš„è³‡æ–™
      const forecastMap = new Map();

      for (let i = 0; i < tempData.length; i++) {
        const date = tempData[i].StartTime.split("T")[0];
        const temp = parseFloat(tempData[i].Temperature);
        const weather = weatherData[i]?.Weather ?? "ç„¡è³‡æ–™";

        if (!forecastMap.has(date)) {
          forecastMap.set(date, { temps: [], weather });
        }
        forecastMap.get(date).temps.push(temp);
      }

      // é¡¯ç¤ºæœªä¾† 7 å¤©
      const output = Array.from(forecastMap.entries())
        .slice(0, 7)
        .map(([date, { temps, weather }]) => {
          const avgTemp = Math.round(temps.reduce((a, b) => a + b, 0) / temps.length);
          return `ğŸ“… ${date}ï¼š${weather}ï¼Œ${avgTemp}Â°C`;
        })
        .join("<br>");

      document.getElementById("weather").innerHTML = output;
    }

    // åˆå§‹åŒ–
    fetchWeather(document.getElementById("city").value);

    // åˆ‡æ›åŸå¸‚
    document.getElementById("city").addEventListener("change", (e) => {
      fetchWeather(e.target.value);
    });
  </script>
</body>
</html>
